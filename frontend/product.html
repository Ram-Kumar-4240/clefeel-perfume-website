<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details - Clefeel Perfumes</title>
  <meta name="description" content="Discover the exquisite details of our premium perfumes. Choose your perfect size and make it yours today.">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <script src="/js/main.js"></script>
  
  <main class="product-detail">
    <div class="container">
      <div class="product-detail-layout">
        <!-- Product Gallery -->
        <div class="product-gallery">
          <div class="product-gallery-main">
            <img id="main-image" src="" alt="Product Image">
          </div>
          <div class="product-gallery-thumbs" id="gallery-thumbs">
            <!-- Thumbnails loaded dynamically -->
          </div>
        </div>
        
        <!-- Product Info -->
        <div class="product-detail-info">
          <h1 class="product-detail-name" id="product-name">Loading...</h1>
          
          <div class="product-detail-meta">
            <span class="product-detail-price" id="product-price">₹0</span>
            <span class="product-detail-stock" id="stock-status">In Stock</span>
          </div>
          
          <p class="product-detail-description" id="product-description">
            Loading product description...
          </p>
          
          <!-- Variant Selector -->
          <div class="variant-selector">
            <label class="variant-label">Select Size</label>
            <div class="variant-options" id="variant-options">
              <!-- Variants loaded dynamically -->
            </div>
          </div>
          
          <!-- Quantity Selector -->
          <div class="quantity-selector">
            <label class="variant-label">Quantity</label>
            <div class="quantity-control">
              <button type="button" onclick="updateQuantity(-1)">−</button>
              <input type="number" id="quantity" value="1" min="1" max="10" readonly>
              <button type="button" onclick="updateQuantity(1)">+</button>
            </div>
          </div>
          
          <!-- Actions -->
          <div class="product-detail-actions">
            <button class="btn btn-primary btn-lg" id="add-to-cart-btn" onclick="addToCart()">
              Add to Cart
            </button>
            <button class="btn btn-outline btn-lg" id="buy-now-btn" onclick="buyNow()">
              Buy Now
            </button>
          </div>
          
          <!-- Additional Info -->
          <div style="margin-top: 40px; padding-top: 32px; border-top: 1px solid var(--color-border);">
            <div style="display: flex; gap: 32px; flex-wrap: wrap;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="2">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                </svg>
                <div>
                  <p style="font-size: 0.875rem; font-weight: 500;">Free Shipping</p>
                  <p style="font-size: 0.75rem; color: var(--color-text-secondary);">On orders above ₹2,000</p>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--color-primary)" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                </svg>
                <div>
                  <p style="font-size: 0.875rem; font-weight: 500;">Secure Payment</p>
                  <p style="font-size: 0.75rem; color: var(--color-text-secondary);">100% secure checkout</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    let product = null;
    let selectedVariant = null;
    let quantity = 1;
    
    // Get slug from URL
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('slug');
    
    if (!slug) {
      window.location.href = '/shop.html';
    }
    
    async function loadProduct() {
      try {
        const data = await Clefeel.api.products.getBySlug(slug);
        product = data.perfume;
        
        if (!product) {
          showDemoProduct();
          return;
        }
        
        // Update page
        document.getElementById('product-name').textContent = product.name;
        document.getElementById('product-description').textContent = product.description || product.short_description || 'No description available.';
        
        // Update images
        if (product.images && product.images.length > 0) {
          document.getElementById('main-image').src = product.images[0];
          document.getElementById('gallery-thumbs').innerHTML = product.images.map((img, i) => `
            <div class="product-gallery-thumb ${i === 0 ? 'active' : ''}" onclick="changeImage('${img}', this)">
              <img src="${img}" alt="${product.name}">
            </div>
          `).join('');
        }
        
        // Render variants
        renderVariants();
        
        // Update meta
        document.title = `${product.name} - Clefeel Perfumes`;
        document.querySelector('meta[name="description"]').content = product.short_description || product.description || '';
        
      } catch (error) {
        console.error('Failed to load product:', error);
        showDemoProduct();
      }
    }
    
    function showDemoProduct() {
      product = {
        id: 1,
        name: "Midnight Oud",
        slug: "midnight-oud",
        description: "A captivating blend of rare oud wood, amber, and exotic spices. This sophisticated fragrance evokes the mystery of Arabian nights, perfect for the modern gentleman who appreciates luxury and refinement.",
        short_description: "Luxury oud fragrance with amber and spices",
        gender: "men",
        images: [
          "https://res.cloudinary.com/dgojt5udn/image/upload/v1771416046/bottle-rose_sajvoq.png",
          "https://res.cloudinary.com/dgojt5udn/image/upload/v1771416046/bottle-vert_mazgji.png",
          "https://res.cloudinary.com/dgojt5udn/image/upload/v1771416045/bottle-soleil_mle6gz.png"
        ],
        variants: [
          { id: 1, size: "30ml", price: 2499, stock_quantity: 15 },
          { id: 2, size: "50ml", price: 3999, stock_quantity: 10 },
          { id: 3, size: "100ml", price: 5999, stock_quantity: 5 }
        ]
      };
      
      document.getElementById('product-name').textContent = product.name;
      document.getElementById('product-description').textContent = product.description;
      document.getElementById('main-image').src = product.images[0];
      document.getElementById('gallery-thumbs').innerHTML = product.images.map((img, i) => `
        <div class="product-gallery-thumb ${i === 0 ? 'active' : ''}" onclick="changeImage('${img}', this)">
          <img src="${img}" alt="${product.name}">
        </div>
      `).join('');
      
      renderVariants();
    }
    
    function renderVariants() {
      const variants = product.variants?.filter(v => v && v.id) || [];
      const container = document.getElementById('variant-options');
      
      if (variants.length === 0) {
        container.innerHTML = '<p>No variants available</p>';
        return;
      }
      
      container.innerHTML = variants.map((variant, i) => `
        <div class="variant-option ${i === 0 ? 'active' : ''} ${variant.stock_quantity === 0 ? 'disabled' : ''}" 
             onclick="selectVariant(${variant.id}, this)"
             data-variant-id="${variant.id}">
          <strong>${variant.size}</strong>
          <div style="font-size: 0.75rem; color: var(--color-text-secondary);">${Clefeel.utils.formatPrice(variant.price)}</div>
        </div>
      `).join('');
      
      // Select first available variant
      const firstAvailable = variants.find(v => v.stock_quantity > 0);
      if (firstAvailable) {
        selectVariant(firstAvailable.id);
      }
    }
    
    function selectVariant(variantId, element) {
      const variants = product.variants?.filter(v => v && v.id) || [];
      selectedVariant = variants.find(v => v.id === variantId);
      
      if (!selectedVariant) return;
      
      // Update UI
      document.querySelectorAll('.variant-option').forEach(el => el.classList.remove('active'));
      if (element) {
        element.classList.add('active');
      } else {
        document.querySelector(`[data-variant-id="${variantId}"]`)?.classList.add('active');
      }
      
      // Update price
      document.getElementById('product-price').textContent = Clefeel.utils.formatPrice(selectedVariant.price);
      
      // Update stock status
      const stockEl = document.getElementById('stock-status');
      if (selectedVariant.stock_quantity === 0) {
        stockEl.textContent = 'Out of Stock';
        stockEl.classList.add('out');
        document.getElementById('add-to-cart-btn').disabled = true;
        document.getElementById('buy-now-btn').disabled = true;
      } else if (selectedVariant.stock_quantity < 5) {
        stockEl.textContent = `Only ${selectedVariant.stock_quantity} left`;
        stockEl.classList.remove('out');
        document.getElementById('add-to-cart-btn').disabled = false;
        document.getElementById('buy-now-btn').disabled = false;
      } else {
        stockEl.textContent = 'In Stock';
        stockEl.classList.remove('out');
        document.getElementById('add-to-cart-btn').disabled = false;
        document.getElementById('buy-now-btn').disabled = false;
      }
    }
    
    function changeImage(src, thumb) {
      document.getElementById('main-image').src = src;
      document.querySelectorAll('.product-gallery-thumb').forEach(el => el.classList.remove('active'));
      thumb.classList.add('active');
    }
    
    function updateQuantity(change) {
      const newQty = quantity + change;
      if (newQty >= 1 && newQty <= 10) {
        quantity = newQty;
        document.getElementById('quantity').value = quantity;
      }
    }
    
    async function addToCart() {
      if (!selectedVariant) {
        Clefeel.toast.error('Please select a size');
        return;
      }
      
      if (!Clefeel.utils.isLoggedIn()) {
        // Save to localStorage for guest cart
        let guestCart = JSON.parse(localStorage.getItem('guest_cart') || '[]');
        const existingItem = guestCart.find(item => item.variantId === selectedVariant.id);
        
        if (existingItem) {
          existingItem.quantity += quantity;
        } else {
          guestCart.push({
            variantId: selectedVariant.id,
            perfumeId: product.id,
            perfumeName: product.name,
            size: selectedVariant.size,
            price: selectedVariant.price,
            image: product.images?.[0],
            quantity: quantity
          });
        }
        
        localStorage.setItem('guest_cart', JSON.stringify(guestCart));
        Clefeel.toast.success('Added to cart');
        Clefeel.cart.updateUI();
        return;
      }
      
      const success = await Clefeel.cart.add(selectedVariant.id, quantity);
      if (success) {
        document.getElementById('quantity').value = 1;
        quantity = 1;
      }
    }
    
    function buyNow() {
      if (!selectedVariant) {
        Clefeel.toast.error('Please select a size');
        return;
      }
      
      // Redirect to buy now page with product info
      const params = new URLSearchParams({
        product: product.name,
        slug: product.slug,
        variant: selectedVariant.id,
        size: selectedVariant.size,
        price: selectedVariant.price,
        qty: quantity
      });
      
      window.location.href = `/buy-now.html?${params.toString()}`;
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', loadProduct);
  </script>
</body>
</html>
