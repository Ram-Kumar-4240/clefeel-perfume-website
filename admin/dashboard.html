<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Clefeel</title>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
    }
    .admin-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      background: #1a1a1a;
      color: white;
      padding: 24px;
    }
    .sidebar-logo {
      font-family: Georgia, serif;
      font-size: 1.5rem;
      margin-bottom: 32px;
    }
    .sidebar-logo span { color: #C9A962; }
    .nav { display: flex; flex-direction: column; gap: 4px; }
    .nav a {
      padding: 12px 16px;
      border-radius: 8px;
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 0.875rem;
      transition: all 0.3s;
    }
    .nav a:hover, .nav a.active {
      background: rgba(201, 169, 98, 0.2);
      color: #C9A962;
    }
    .main {
      padding: 32px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }
    .header h1 { font-size: 1.75rem; }
    .btn {
      padding: 10px 20px;
      background: #C9A962;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .btn:hover { background: #B8984F; }
    .btn-secondary {
      background: #666;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .stat-label {
      font-size: 0.875rem;
      color: #666;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 600;
      color: #C9A962;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .card-title { font-size: 1.125rem; }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      color: #666;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .status-pending { background: #FFF3CD; color: #856404; }
    .status-confirmed { background: #D4EDDA; color: #155724; }
    .status-shipped { background: #CCE5FF; color: #004085; }
    .status-delivered { background: #D4EDDA; color: #155724; }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: white;
      padding: 32px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 0.875rem; margin-bottom: 6px; }
    input, select, textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 0.875rem;
    }
    .variant-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 12px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar">
      <div class="sidebar-logo">Cle<span>feel</span></div>
      <nav class="nav">
        <a href="#" class="active" onclick="showSection('dashboard')">Dashboard</a>
        <a href="#" onclick="showSection('products')">Products</a>
        <a href="#" onclick="showSection('orders')">Orders</a>
        <a href="#" onclick="showSection('enquiries')">Enquiries</a>
        <a href="#" onclick="logout()">Logout</a>
      </nav>
    </aside>
    
    <main class="main">
      <!-- Dashboard Section -->
      <div id="dashboard-section">
        <div class="header">
          <h1>Dashboard</h1>
          <button class="btn" onclick="openProductModal()">+ Add Product</button>
        </div>
        
        <div class="stats-grid" id="stats-container">
          <div class="stat-card">
            <div class="stat-label">Total Orders (30d)</div>
            <div class="stat-value" id="stat-orders">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Revenue (30d)</div>
            <div class="stat-value" id="stat-revenue">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pending Orders</div>
            <div class="stat-value" id="stat-pending">-</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Products</div>
            <div class="stat-value" id="stat-products">-</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Recent Orders</h3>
            <a href="#" onclick="showSection('orders')">View All</a>
          </div>
          <table id="recent-orders">
            <tr><td>Loading...</td></tr>
          </table>
        </div>
      </div>
      
      <!-- Products Section -->
      <div id="products-section" style="display: none;">
        <div class="header">
          <h1>Products</h1>
          <button class="btn" onclick="openProductModal()">+ Add Product</button>
        </div>
        <div class="card">
          <table id="products-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Gender</th>
                <th>Variants</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <!-- Orders Section -->
      <div id="orders-section" style="display: none;">
        <div class="header">
          <h1>Orders</h1>
        </div>
        <div class="card">
          <table id="orders-table">
            <thead>
              <tr>
                <th>Order #</th>
                <th>Customer</th>
                <th>Total</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      
      <!-- Enquiries Section -->
      <div id="enquiries-section" style="display: none;">
        <div class="header">
          <h1>Enquiries</h1>
        </div>
        <div class="card">
          <p>Enquiries management coming soon.</p>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Product Modal -->
  <div class="modal" id="product-modal">
    <div class="modal-content">
      <h2 style="margin-bottom: 24px;">Add Product</h2>
      <form id="product-form">
        <div class="form-group">
          <label>Product Name</label>
          <input type="text" id="prod-name" required>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="prod-desc" rows="3"></textarea>
        </div>
        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div class="form-group">
            <label>Gender</label>
            <select id="prod-gender">
              <option value="men">Men</option>
              <option value="women">Women</option>
              <option value="unisex">Unisex</option>
            </select>
          </div>
          <div class="form-group">
            <label>Category</label>
            <input type="text" id="prod-category" placeholder="e.g., Floral, Woody">
          </div>
        </div>
        <div class="form-group">
          <label>Variants (Size, Price, Stock)</label>
          <div id="variants-container">
            <div class="variant-row">
              <input type="text" placeholder="Size (e.g., 50ml)" class="var-size">
              <input type="number" placeholder="Price" class="var-price">
              <input type="number" placeholder="Stock" class="var-stock">
              <button type="button" onclick="this.parentElement.remove()">×</button>
            </div>
          </div>
          <button type="button" class="btn btn-secondary" onclick="addVariantRow()" style="margin-top: 8px;">+ Add Variant</button>
        </div>
        <div style="display: flex; gap: 12px; margin-top: 24px;">
          <button type="button" class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
          <button type="submit" class="btn">Save Product</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000/api' 
      : 'https://your-api-domain.com/api';
    
    function getToken() {
      return localStorage.getItem('admin_token');
    }
    
    async function apiRequest(endpoint, options = {}) {
      const response = await fetch(`${API_URL}${endpoint}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getToken()}`,
          ...options.headers
        }
      });
      return response.json();
    }
    
    // Check auth
    if (!getToken()) {
      window.location.href = '/admin/';
    }
    
    function showSection(section) {
      document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('dashboard-section').style.display = section === 'dashboard' ? 'block' : 'none';
      document.getElementById('products-section').style.display = section === 'products' ? 'block' : 'none';
      document.getElementById('orders-section').style.display = section === 'orders' ? 'block' : 'none';
      document.getElementById('enquiries-section').style.display = section === 'enquiries' ? 'block' : 'none';
      
      if (section === 'products') loadProducts();
      if (section === 'orders') loadAllOrders();
    }
    
    async function loadDashboard() {
      try {
        const stats = await apiRequest('/admin/dashboard');
        document.getElementById('stat-orders').textContent = stats.stats.orders_30d;
        document.getElementById('stat-revenue').textContent = '₹' + stats.stats.revenue_30d.toLocaleString();
        document.getElementById('stat-pending').textContent = stats.stats.pending_orders;
        document.getElementById('stat-products').textContent = stats.stats.active_products;
        
        const orders = await apiRequest('/admin/dashboard/recent-orders');
        document.getElementById('recent-orders').innerHTML = orders.orders.map(o => `
          <tr>
            <td><strong>#${o.order_number}</strong></td>
            <td>${o.customer?.name || 'Guest'}</td>
            <td>₹${o.total_amount}</td>
            <td><span class="status status-${o.status}">${o.status}</span></td>
            <td><button class="btn" style="padding: 6px 12px; font-size: 0.75rem;" onclick="updateOrderStatus(${o.id}, 'confirmed')">Confirm</button></td>
          </tr>
        `).join('') || '<tr><td colspan="5">No orders</td></tr>';
      } catch (e) {
        console.error(e);
      }
    }
    
    async function loadProducts() {
      try {
        const data = await apiRequest('/admin/perfumes');
        document.querySelector('#products-table tbody').innerHTML = data.perfumes.map(p => `
          <tr>
            <td>${p.name}</td>
            <td>${p.gender}</td>
            <td>${p.variants?.filter(v => v && v.id).length || 0} sizes</td>
            <td>${p.is_active ? 'Active' : 'Inactive'}</td>
            <td><button class="btn" style="padding: 6px 12px; font-size: 0.75rem;">Edit</button></td>
          </tr>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }
    
    async function loadAllOrders() {
      try {
        const data = await apiRequest('/admin/orders');
        document.querySelector('#orders-table tbody').innerHTML = data.orders.map(o => `
          <tr>
            <td>#${o.order_number}</td>
            <td>${o.customer?.name || 'Guest'}<br><small>${o.customer?.email || o.guest_email}</small></td>
            <td>₹${o.total_amount}</td>
            <td><span class="status status-${o.status}">${o.status}</span></td>
            <td>${new Date(o.created_at).toLocaleDateString()}</td>
            <td>
              <select onchange="updateOrderStatus(${o.id}, this.value)">
                <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>Pending</option>
                <option value="confirmed" ${o.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                <option value="shipped" ${o.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                <option value="delivered" ${o.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                <option value="cancelled" ${o.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
              </select>
            </td>
          </tr>
        `).join('');
      } catch (e) {
        console.error(e);
      }
    }
    
    async function updateOrderStatus(id, status) {
      try {
        await apiRequest(`/admin/orders/${id}/status`, {
          method: 'PUT',
          body: JSON.stringify({ status })
        });
        loadDashboard();
        loadAllOrders();
      } catch (e) {
        alert('Failed to update status');
      }
    }
    
    function openProductModal() {
      document.getElementById('product-modal').classList.add('active');
    }
    
    function closeProductModal() {
      document.getElementById('product-modal').classList.remove('active');
    }
    
    function addVariantRow() {
      const row = document.createElement('div');
      row.className = 'variant-row';
      row.innerHTML = `
        <input type="text" placeholder="Size" class="var-size">
        <input type="number" placeholder="Price" class="var-price">
        <input type="number" placeholder="Stock" class="var-stock">
        <button type="button" onclick="this.parentElement.remove()">×</button>
      `;
      document.getElementById('variants-container').appendChild(row);
    }
    
    document.getElementById('product-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const variants = [];
      document.querySelectorAll('.variant-row').forEach(row => {
        const size = row.querySelector('.var-size').value;
        const price = row.querySelector('.var-price').value;
        const stock = row.querySelector('.var-stock').value;
        if (size && price) {
          variants.push({ size, price: parseFloat(price), stock: parseInt(stock) || 0 });
        }
      });
      
      try {
        await apiRequest('/perfumes', {
          method: 'POST',
          body: JSON.stringify({
            name: document.getElementById('prod-name').value,
            description: document.getElementById('prod-desc').value,
            gender: document.getElementById('prod-gender').value,
            category: document.getElementById('prod-category').value,
            variants
          })
        });
        
        closeProductModal();
        e.target.reset();
        loadProducts();
        loadDashboard();
        alert('Product added successfully');
      } catch (e) {
        alert('Failed to add product');
      }
    });
    
    function logout() {
      localStorage.removeItem('admin_token');
      localStorage.removeItem('admin_user');
      window.location.href = '/admin/';
    }
    
    loadDashboard();
  </script>
</body>
</html>
